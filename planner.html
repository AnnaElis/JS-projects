<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–º–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏</title>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Jost', sans-serif;
            padding: 20px;
            background: #f5f5f5;
            margin: 0;
        }
        #cards-container {
            position: relative;
            min-height: 80vh;
            margin-top: 20px;
        }
        .card {
            position: absolute;
            width: 160px;
            height: 160px;
            background: #fff;
            border: 1px solid #c6c6c6;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            cursor: grab;
            display: flex;
            flex-direction: column;
            font-family: 'Jost', sans-serif;
            user-select: none;
        }
        .card:active {
            cursor: grabbing;
        }
        .card.focused {
            outline: 2px solid #f97316;
        }
        .card-content {
            flex-grow: 1;
            outline: none;
            overflow: auto;
            font-family: inherit;
            margin-bottom: 10px;
            cursor: move;
        }
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        .color-menu-btn {
            position: absolute;
            left: -8px;
            bottom: -8px;
            width: 24px;
            height: 24px;
            background: white;
            border: 1px solid #c6c6c6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 2;
        }
        .color-palette {
            position: absolute;
            left: 0;
            bottom: -72px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            display: none;
            flex-wrap: wrap;
            gap: 6px;
            width: 120px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .color-palette.visible {
            display: flex;
        }
        .color-option {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 1px solid #eee;
            transition: transform 0.2s;
        }
        .color-option:hover {
            transform: scale(1.2);
        }
        .priority-circle {
            position: absolute;
            right: -8px;
            bottom: -8px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            border: 2px solid #f97316;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #f97316;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 2;
        }
        .priority-input {
            width: 100%;
            height: 100%;
            text-align: center;
            border: none;
            background: transparent;
            color: #f97316;
            font-weight: 600;
            font-family: 'Jost', sans-serif;
            outline: none;
            cursor: pointer;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Jost', sans-serif;
            transition: all 0.2s;
        }
        .btn-add {
            background: #f97316;
            color: white;
        }
        .btn-add:hover {
            background: #e65c0d;
        }
        .btn-save {
            background: #3b82f6;
            color: white;
        }
        .btn-save:hover {
            background: #2563eb;
        }
        .btn-reset {
            background: #e2e8f0;
        }
        .btn-reset:hover {
            background: #cbd5e1;
        }
        .btn-export {
            background: #10b981;
            color: white;
        }
        .btn-export:hover {
            background: #0d9e6e;
        }
        .hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .hint.visible {
            opacity: 1;
        }
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }
        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
        }
        .context-menu-item:hover {
            background: #f5f5f5;
        }
    </style>
</head>
<body>
    <div class="controls">
        <button class="btn btn-add" id="addCard">+ –ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞</button>
        <button class="btn btn-save" id="saveBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn btn-reset" id="resetBtn">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
        <button class="btn btn-export" id="exportBtn">üì∑ –≠–∫—Å–ø–æ—Ä—Ç PNG</button>
    </div>
    <div id="cards-container"></div>
    <div class="hint" id="hint"></div>
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" id="copyMenuItem">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
        <div class="context-menu-item" id="pasteMenuItem">–í—Å—Ç–∞–≤–∏—Ç—å</div>
        <div class="context-menu-item" id="deleteMenuItem">–£–¥–∞–ª–∏—Ç—å</div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('cards-container');
            const hint = document.getElementById('hint');
            const contextMenu = document.getElementById('contextMenu');
            const copyMenuItem = document.getElementById('copyMenuItem');
            const pasteMenuItem = document.getElementById('pasteMenuItem');
            const deleteMenuItem = document.getElementById('deleteMenuItem');
            
            let selectedCard = null;
            let copiedCardData = null;
            let isDragging = false;
            let startX, startY, initialX, initialY;
            let contextMenuCard = null;
            
            // –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞
            const presetColors = [
                '#ffffff', '#62bb35', '#fd817d', '#208ea3', 
                '#fdae33', '#8d9f9b', '#fca7e4', '#4178bc',
                '#a4c61a', '#7a71f6', '#e37cff', '#78eeef',
                '#78efcf', '#97ef78', '#c9ef78', '#ef9a78',
                '#eecc16'
            ];
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
            loadCards();
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
            document.getElementById('addCard').addEventListener('click', function() {
                createCard({
                    x: Math.random() * (window.innerWidth - 180),
                    y: Math.random() * (window.innerHeight - 180),
                    color: '#ffffff',
                    text: '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞',
                    priority: ''
                });
            });
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
            document.getElementById('saveBtn').addEventListener('click', saveCards);
            
            // –°–±—Ä–æ—Å –∫–∞—Ä—Ç–æ—á–µ–∫
            document.getElementById('resetBtn').addEventListener('click', function() {
                if(confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏?')) {
                    localStorage.removeItem('saved-cards');
                    container.innerHTML = '';
                    showHint('–í—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —É–¥–∞–ª–µ–Ω—ã');
                }
            });
            
            // –≠–∫—Å–ø–æ—Ä—Ç –≤ PNG
            document.getElementById('exportBtn').addEventListener('click', exportToPNG);
            
            // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
            copyMenuItem.addEventListener('click', function() {
                if (contextMenuCard) {
                    copiedCardData = getCardData(contextMenuCard);
                    showHint('–ö–∞—Ä—Ç–æ—á–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞');
                }
                contextMenu.style.display = 'none';
            });
            
            pasteMenuItem.addEventListener('click', function() {
                if (copiedCardData) {
                    createCard({
                        ...copiedCardData,
                        x: copiedCardData.x + 20,
                        y: copiedCardData.y + 20
                    });
                }
                contextMenu.style.display = 'none';
            });
            
            deleteMenuItem.addEventListener('click', function() {
                if (contextMenuCard) {
                    contextMenuCard.remove();
                    saveCards();
                    showHint('–ö–∞—Ä—Ç–æ—á–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
                }
                contextMenu.style.display = 'none';
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
            document.addEventListener('click', function() {
                contextMenu.style.display = 'none';
            });
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ª—é–±–æ–π —Ä–∞—Å–∫–ª–∞–¥–∫–µ)
            document.addEventListener('keydown', function(e) {
                // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (Ctrl+C –∏–ª–∏ Command+C)
                if ((e.ctrlKey || e.metaKey) && e.keyCode === 67 && selectedCard) {
                    copiedCardData = getCardData(selectedCard);
                    showHint('–ö–∞—Ä—Ç–æ—á–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ (Ctrl+V –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏)');
                    e.preventDefault();
                    return false;
                }
                
                // –í—Å—Ç–∞–≤–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ (Ctrl+V –∏–ª–∏ Command+V)
                if ((e.ctrlKey || e.metaKey) && e.keyCode === 86 && copiedCardData) {
                    createCard({
                        ...copiedCardData,
                        x: copiedCardData.x + 20,
                        y: copiedCardData.y + 20
                    });
                    e.preventDefault();
                    return false;
                }
                
                // –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (Delete)
                if (e.key === 'Delete' && selectedCard) {
                    selectedCard.remove();
                    saveCards();
                    showHint('–ö–∞—Ä—Ç–æ—á–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
                }
            });
            
            // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø–æ –ø—Ä–∞–≤–æ–π –∫–Ω–æ–ø–∫–µ –º—ã—à–∏
            document.addEventListener('contextmenu', function(e) {
                const card = e.target.closest('.card');
                if (card) {
                    e.preventDefault();
                    contextMenuCard = card;
                    contextMenu.style.display = 'block';
                    contextMenu.style.left = e.pageX + 'px';
                    contextMenu.style.top = e.pageY + 'px';
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø—É–Ω–∫—Ç—ã –º–µ–Ω—é
                    pasteMenuItem.style.display = copiedCardData ? 'block' : 'none';
                }
            });
            
            // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è
            document.addEventListener('click', function(e) {
                const clickedCard = e.target.closest('.card');
                
                // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
                document.querySelectorAll('.card').forEach(card => {
                    card.classList.remove('focused');
                });
                
                // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ - –≤—ã–¥–µ–ª—è–µ–º –µ—ë
                if (clickedCard) {
                    selectedCard = clickedCard;
                    clickedCard.classList.add('focused');
                    e.stopPropagation();
                } else {
                    selectedCard = null;
                }
            });
            
            // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
            function createCard(data) {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.left = data.x + 'px';
                card.style.top = data.y + 'px';
                card.style.backgroundColor = data.color;
                
                card.innerHTML = `
                    <div class="card-content" contenteditable="true">${data.text}</div>
                    <div class="card-footer">
                        <div class="color-menu-btn">‚ãØ</div>
                        <div class="color-palette"></div>
                        <div class="priority-circle">
                            <input type="text" class="priority-input" maxlength="2" value="${data.priority}" placeholder="1">
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
                setupCard(card, data.color);
                return card;
            }
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
            function setupCard(card, initialColor) {
                const colorBtn = card.querySelector('.color-menu-btn');
                const colorPalette = card.querySelector('.color-palette');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ü–≤–µ—Ç–æ–≤
                presetColors.forEach(color => {
                    const colorOption = document.createElement('div');
                    colorOption.className = 'color-option';
                    colorOption.style.backgroundColor = color;
                    
                    colorOption.addEventListener('click', function() {
                        card.style.backgroundColor = color;
                        saveCards();
                        colorPalette.classList.remove('visible');
                    });
                    
                    colorPalette.appendChild(colorOption);
                });
                
                // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–ª–∏—Ç—Ä—ã
                colorBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    colorPalette.classList.toggle('visible');
                });
                
                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–ª–∏—Ç—Ä—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
                document.addEventListener('click', function(e) {
                    if (!card.contains(e.target)) {
                        colorPalette.classList.remove('visible');
                    }
                });
                
                // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
                card.addEventListener('mousedown', function(e) {
                    // –ò—Å–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ priority-input
                    if (e.target.classList.contains('priority-input')) {
                        return;
                    }
                    
                    // –î–ª—è contenteditable —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
                    if (e.target.contentEditable === 'true') {
                        e.preventDefault();
                    }
                    
                    selectedCard = card;
                    card.classList.add('focused');
                    card.style.zIndex = 1000;
                    document.querySelectorAll('.card').forEach(c => {
                        if(c !== card) c.style.zIndex = 1;
                    });
                    
                    // –ù–∞—á–∞–ª–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    initialX = parseInt(card.style.left);
                    initialY = parseInt(card.style.top);
                });
                
                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                const priorityInput = card.querySelector('.priority-input');
                priorityInput.addEventListener('change', saveCards);
                priorityInput.addEventListener('input', function() {
                    // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
                    this.value = this.value.replace(/\D/g, '');
                });
                
                // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ —Ç–µ–∫—Å—Ç—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const content = card.querySelector('.card-content');
                content.addEventListener('dblclick', function(e) {
                    e.stopPropagation();
                    const range = document.createRange();
                    range.selectNodeContents(this);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                });
            }
            
            // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
            document.addEventListener('mousemove', function(e) {
                if (!isDragging || !selectedCard) return;
                
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                selectedCard.style.left = (initialX + dx) + 'px';
                selectedCard.style.top = (initialY + dy) + 'px';
            });
            
            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    saveCards();
                }
            });
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–∫–∏
            function getCardData(card) {
                return {
                    x: parseInt(card.style.left),
                    y: parseInt(card.style.top),
                    color: card.style.backgroundColor,
                    text: card.querySelector('.card-content').innerText,
                    priority: card.querySelector('.priority-input').value
                };
            }
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
            function saveCards() {
                const cards = [];
                document.querySelectorAll('.card').forEach(card => {
                    cards.push(getCardData(card));
                });
                localStorage.setItem('saved-cards', JSON.stringify(cards));
            }
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
            function loadCards() {
                const savedCards = localStorage.getItem('saved-cards');
                if(savedCards) {
                    JSON.parse(savedCards).forEach(cardData => {
                        createCard(cardData);
                    });
                }
            }
            
            // –≠–∫—Å–ø–æ—Ä—Ç –≤ PNG
            function exportToPNG() {
                showHint('–ò–¥—ë—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...');
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞ –≤—Ä–µ–º—è —ç–∫—Å–ø–æ—Ä—Ç–∞
                const controls = document.querySelector('.controls');
                controls.style.opacity = '0';
                
                html2canvas(container, {
                    backgroundColor: '#f5f5f5',
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    scrollX: 0,
                    scrollY: 0,
                    windowWidth: document.documentElement.scrollWidth,
                    windowHeight: document.documentElement.scrollHeight
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = '–∫–∞—Ä—Ç–æ—á–∫–∏-' + new Date().toISOString().slice(0, 10) + '.png';
                    link.href = canvas.toDataURL('image/png', 1.0);
                    link.click();
                    
                    controls.style.opacity = '1';
                    showHint('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
                });
            }
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É
            function showHint(text) {
                hint.textContent = text;
                hint.classList.add('visible');
                setTimeout(() => hint.classList.remove('visible'), 3000);
            }
        });
    </script>
</body>
</html>
